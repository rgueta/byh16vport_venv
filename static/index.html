<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Videoportero</title>
    </head>
    <body>
        <h3>Videoportero</h3>
        <video
            id="remoteVideo"
            autoplay
            playsinline
            controls
            style="width: 640px; height: 480px; border: 1px solid #333"
        ></video>
        <div>
            <label
                >Token:
                <input
                    id="token"
                    value="cambia_este_token"
                    style="width: 280px"
            /></label>
            <button id="connect">Conectar</button>
            <button id="hangup" disabled>Desconectar</button>
            <button id="unlock" disabled>Abrir puerta (si autorizado)</button>
        </div>
        <script>
            let pc = null;
            const remoteVideo = document.getElementById("remoteVideo");

            async function connect() {
                const token = document.getElementById("token").value;
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
                });

                pc.ontrack = (e) => {
                    if (remoteVideo.srcObject !== e.streams[0]) {
                        remoteVideo.srcObject = e.streams[0];
                    }
                };

                // add local mic to send to server (optional)
                let localStream = null;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        audio: true,
                        video: false,
                    });
                    localStream
                        .getTracks()
                        .forEach((t) => pc.addTrack(t, localStream));
                } catch (e) {
                    console.log("No mic or denied", e);
                }

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const res = await fetch("/offer", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type,
                        token: token,
                    }),
                });

                if (!res.ok) {
                    alert("Token inv√°lido o error");
                    return;
                }
                const answer = await res.json();
                await pc.setRemoteDescription(answer);
                document.getElementById("hangup").disabled = false;
                document.getElementById("unlock").disabled = false;
            }

            function hangup() {
                if (pc) {
                    pc.close();
                    pc = null;
                }
                document.getElementById("hangup").disabled = true;
                document.getElementById("unlock").disabled = true;
            }

            async function unlockDoor() {
                const token = document.getElementById("token").value;
                const res = await fetch(
                    "/unlock?token=" + encodeURIComponent(token),
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ reason: "web:button" }),
                    },
                );
                if (res.ok) alert("Pedido enviado");
                else alert("No autorizado");
            }

            document.getElementById("connect").onclick = connect;
            document.getElementById("hangup").onclick = hangup;
            document.getElementById("unlock").onclick = unlockDoor;
        </script>
    </body>
</html>
