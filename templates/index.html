<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Videoportero - Panel</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/pages/index.css') }}"
        />
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üö™ Video Portero Inteligente..</h1>
                <p>Stream MJPEG Funcional - Modo Diagn√≥stico</p>
            </div>

            <div class="status-bar">
                <div class="status-item" id="streamStatus">
                    <h3>Stream</h3>
                    <p>üîÑ CONECTANDO...</p>
                </div>
                <div class="status-item" id="doorStatus">
                    <h3>Puerta</h3>
                    <p>üîí CERRADA</p>
                </div>
                <div class="status-item" id="frameStatus">
                    <h3>Frames</h3>
                    <p>0</p>
                </div>
            </div>

            <!-- Video + header -->
            <div class="card video-card">
                <div class="topbar">
                    <div class="title">Videoportero</div>
                    <div class="status">
                        <span class="dot" id="connDot"></span
                        ><span id="connText">Conectando...</span>
                    </div>
                </div>

                <div class="video-inner" id="videoInner">
                    <img
                        id="stream"
                        src="{{ url_for('video_feed') }}"
                        width="640"
                        height="480"
                    />
                    <canvas
                        id="canvas"
                        width="640"
                        height="480"
                        style="display: none"
                    ></canvas>
                </div>

                <div
                    style="
                        padding: 10px 4px;
                        display: flex;
                        gap: 10px;
                        align-items: center;
                        justify-content: space-between;
                    "
                >
                    <div class="small">
                        Touch-friendly UI ‚Äî compatible PC & m√≥viles
                    </div>
                    <div class="small">
                        FPS estimado: <span id="fps">‚Äî</span>
                    </div>
                </div>
            </div>

            <!-- Control panel -->
            <aside class="controls card">
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        align-items: center;
                        justify-content: space-between;
                    "
                >
                    <strong>Controles</strong>
                    <button
                        id="reloadBtn"
                        class="btn"
                        style="padding: 8px 10px; font-size: 0.9rem"
                    >
                        üîÅ Refrescar
                    </button>
                </div>

                <div class="btn-grid" style="margin-top: 6px">
                    <button
                        class="btn primary"
                        id="openBtn"
                        title="Abrir port√≥n/puerta"
                    >
                        üîì Abrir
                    </button>
                    <button
                        class="btn warn"
                        id="unlockBtn"
                        title="Desbloquear remoto"
                    >
                        üîë Desbloquear
                    </button>
                    <button
                        class="btn"
                        id="snapshotBtn"
                        title="Tomar foto"
                        onclick="capturar()"
                    >
                        üì∏ Captura.
                    </button>
                    <button
                        class="btn"
                        id="talkBtn"
                        title="Hablar (push to talk)"
                    >
                        üéôÔ∏è Hablar
                    </button>
                    <button
                        class="btn"
                        id="fullscreenBtn"
                        title="Pantalla completa"
                    >
                        ‚§¢ Pantalla
                    </button>
                </div>

                <div style="margin-top: 12px">
                    <div class="small">Captura reciente</div>
                    <div class="thumb" id="thumb">
                        <span id="thumbText">Sin captura</span>
                    </div>
                </div>

                <div class="muted-block" style="margin-top: 8px">
                    <div>
                        Acciones enviadas a: <code id="apiBase">/api/</code>
                    </div>
                    <div class="fs-hint">
                        Consejo: en m√≥vil usa modo horizontal para mejor visual.
                    </div>
                </div>
            </aside>
        </div>

        <script>
            const STREAM_MJPEG = "/live.m3u8";
            const STREAM_HLS = "{{video_url}}"; // si no hay HLS, no es necesario
            const API_BASE = "/api"; // ejemplo: POST /api/open, /api/unlock, /api/snapshot, /api/talk

            var video = document.getElementById("videoStream");
            var videoSrc = "{{ video_url }}"; // Nombre de tu archivo M3U8

            if (Hls.isSupported()) {
                var hls = new Hls({
                    // Ajustes para baja latencia (corta la lista de reproducci√≥n)
                    startPosition: -1,
                    liveSyncDurationCount: 2,
                    liveMaxLatencyDurationCount: 3,
                });
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play();
                });
            } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                // Soporte nativo de HLS (para Safari)
                video.src = videoSrc;
                video.addEventListener("loadedmetadata", function () {
                    setTimeout(() => {
                        video.play();
                        showNotification("Video recargado", "success");
                    }, 100);
                });
            }

            // Update UI
            document.getElementById("apiBase").textContent = API_BASE;

            // Elements
            const mjpeg = document.getElementById("mjpeg");
            const hlsVideo = document.getElementById("videoStream");
            const connDot = document.getElementById("connDot");
            const connText = document.getElementById("connText");
            const fpsLabel = document.getElementById("fps");
            const thumb = document.getElementById("thumb");
            const thumbText = document.getElementById("thumbText");

            // Try to detect if MJPEG fails ‚Äî then fallback to HLS/video
            let lastFrameTime = performance.now();
            let frames = 0;
            let fpsInterval = null;

            function setStatus(connected) {
                if (connected) {
                    connDot.style.background = "#10b981";
                    connText.textContent = "Conectado";
                } else {
                    connDot.style.background = "#ef4444";
                    connText.textContent = "Desconectado";
                }
            }

            // Estimate fps for MJPEG by watching image loads
            // mjpeg.addEventListener("load", () => {
            //     frames++;
            //     setStatus(true);
            // });
            // mjpeg.addEventListener("error", () => {
            //     // If error, switch to video fallback
            //     console.warn(
            //         "MJPEG stream error ‚Äî intentando fallback a video HLS.",
            //     );
            //     setStatus(false);
            //     tryFallbackToVideo();
            // });

            // Start FPS meter
            fpsInterval = setInterval(() => {
                fpsLabel.textContent = frames;
                frames = 0;
            }, 1000);

            // Capture image--------
            function capturar() {
                const video = document.getElementById("stream");
                const canvas = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const enlace = document.createElement("a");
                enlace.download =
                    "captura_" +
                    new Date().toISOString().replace(/[:.]/g, "_") +
                    ".jpg";
                enlace.href = canvas.toDataURL("image/jpeg");
                enlace.click();
            }

            // Fallback function ‚Äî shows <video> and hides <img>
            function tryFallbackToVideo() {
                // Only attempt if hls URL likely available
                if (!STREAM_HLS) {
                    connText.textContent = "Stream no disponible";
                    return;
                }
                mjpeg.style.display = "none";
                hlsVideo.style.display = "block";
                // If the browser supports HLS natively (Safari) it will play. For others you'd need hls.js:
                // We don't include hls.js here; if needed, add it and attach to hlsVideo.
                hlsVideo.src = STREAM_HLS;
                hlsVideo.play().catch(() => {
                    /* ignore autoplay block */
                });
            }

            // Button actions
            async function postAction(action, body = {}) {
                const url = `${API_BASE}/${action}`;
                try {
                    const r = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    if (!r.ok) throw new Error("HTTP " + r.status);
                    const json = await r.json().catch(() => ({ ok: true }));
                    return { ok: true, data: json };
                } catch (err) {
                    console.error("postAction", action, err);
                    return { ok: false, err: err };
                }
            }

            // Hook buttons
            document
                .getElementById("openBtn")
                .addEventListener("click", async () => {
                    const resp = await postAction("open");
                    if (resp.ok) alert("Se ha enviado la orden de abrir.");
                    else
                        alert(
                            "Error enviando orden: " +
                                (resp.err && resp.err.message),
                        );
                });

            document
                .getElementById("unlockBtn")
                .addEventListener("click", async () => {
                    const resp = await postAction("unlock");
                    if (resp.ok) alert("Desbloqueo remoto enviado.");
                    else alert("Error enviando desbloqueo.");
                });

            document
                .getElementById("snapshotBtn")
                .addEventListener("click", async () => {
                    // If server supports snapshot endpoint that returns image bytes/base64
                    const resp = await postAction("snapshot");
                    if (resp.ok && resp.data && resp.data.image_base64) {
                        displayThumbnail(resp.data.image_base64);
                    } else if (resp.ok && resp.data && resp.data.url) {
                        displayThumbnailFromUrl(resp.data.url);
                    } else {
                        alert(
                            "Captura solicitada. Si no ves imagen, aseg√∫rate que /api/snapshot devuelve base64 o url.",
                        );
                    }
                });

            document
                .getElementById("talkBtn")
                .addEventListener("click", async () => {
                    // Simple toggle: start/stop talk. Could be long-press for PTT in the future.
                    const resp = await postAction("talk_toggle");
                    if (resp.ok) alert("Toggle talk enviado.");
                    else alert("Error en talk.");
                });

            // Fullscreen
            document
                .getElementById("fullscreenBtn")
                .addEventListener("click", () => {
                    const el = document.getElementById("videoInner");
                    if (!document.fullscreenElement) {
                        el.requestFullscreen?.();
                    } else {
                        document.exitFullscreen?.();
                    }
                });

            // Reload stream
            document
                .getElementById("reloadBtn")
                .addEventListener("click", () => {
                    // reload image by adding cache-buster
                    mjpeg.src = STREAM_MJPEG + "?_t=" + Date.now();
                    setStatus(true);
                    hlsVideo.pause();
                    hlsVideo.style.display = "none";
                    mjpeg.style.display = "block";
                });

            // Thumbnail display helpers
            function displayThumbnail(base64) {
                thumb.innerHTML = "";
                const img = document.createElement("img");
                img.src = "data:image/jpeg;base64," + base64;
                thumb.appendChild(img);
                thumbText.style.display = "none";
            }
            function displayThumbnailFromUrl(url) {
                thumb.innerHTML = "";
                const img = document.createElement("img");
                img.src = url;
                thumb.appendChild(img);
                thumbText.style.display = "none";
            }

            // Optional: ping server health every N seconds
            async function pingHealth() {
                // try {
                //     const r = await fetch(API_BASE + "/health");
                //     if (r.ok) setStatus(true);
                //     else setStatus(false);
                // } catch (e) {
                //     setStatus(false);
                // }
            }
            setInterval(pingHealth, 5000);
            pingHealth();

            // polite note: if your stream is HLS and browser lacks native support, add hls.js and attach it.
            // For MJPEG, keep /video_feed as an infinite multipart/x-mixed-replace stream from Flask.
        </script>
    </body>
</html>
