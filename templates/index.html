<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Videoportero</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/pages/index.css') }}"
        />
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h2>üö™ Video Portero Inteligente</h2>
            </div>

            <!-- Video + header -->
            <div class="card video-card">
                <div class="video-inner" id="videoInner">
                    <img id="stream" src="{{ url_for('video_feed') }}" />
                    <canvas
                        id="canvas"
                        width="640"
                        height="480"
                        style="display: none"
                    ></canvas>
                </div>

                <div class="status">
                    <div id="nfc-status" class="small">Status</div>
                </div>

                <!-- Accordion Principal -->
                <div class="main-accordion">
                    <div
                        class="accordion-header"
                        onclick="toggleMainAccordion()"
                    >
                        <div class="accordion-title">
                            üìä Tarjetas desconocidas
                        </div>
                        <div class="accordion-icon" id="mainAccordionIcon">
                            ‚ñº
                        </div>
                    </div>
                    <div class="accordion-content" id="mainAccordionContent">
                        <!-- Controles para agregar elementos -->
                        <div class="counter" id="elementCounter">
                            Total desconocidas:
                            <span id="elementCount">0</span>
                        </div>

                        <!-- Tabla de elementos -->
                        <div class="table-container">
                            <table class="elements-table">
                                <thead>
                                    <tr>
                                        <th width="150">ID</th>
                                        <th>Nombre</th>
                                        <th width="180">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="elementsTableBody">
                                    <tr>
                                        <td colspan="4">
                                            <div
                                                class="empty-state"
                                                id="emptyState"
                                            >
                                                üìù No hay elementos en la
                                                tabla.<br />
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control panel -->
            <aside class="controls card">
                <div class="btn-grid" style="margin-top: 6px">
                    <button
                        class="btn primary"
                        id="openBtn"
                        title="Abrir port√≥n/puerta"
                        onclick="abrirPuerta()"
                    >
                        üîì Abrir
                    </button>
                    <button
                        class="btn warn"
                        id="unlockBtn"
                        title="Desbloquear remoto"
                    >
                        üîë Desbloquear
                    </button>
                    <button
                        class="btn"
                        id="snapshotBtn"
                        title="Tomar foto"
                        onclick="capturar()"
                    >
                        üì∏ Captura.
                    </button>
                    <button
                        class="btn"
                        id="talkBtn"
                        title="Hablar (push to talk)"
                    >
                        üéôÔ∏è Hablar
                    </button>
                    <button
                        class="btn"
                        id="fullscreenBtn"
                        title="Pantalla completa"
                    >
                        ‚§¢ Pantalla
                    </button>
                    <button
                        id="reloadBtn"
                        class="btn"
                        style="padding: 8px 10px; font-size: 0.9rem"
                    >
                        üîÅ Refrescar
                    </button>
                </div>

                <div style="margin-top: 12px">
                    <div class="small">Accesos reciente</div>
                    <div class="accordion" id="accordion">
                        {% for item in items %}
                        <div class="accordion-item" data-id="{{ item.id }}">
                            <div
                                class="accordion-header"
                                onclick="toggleAccordion(this)"
                            >
                                <h3>{{ item.title }}</h3>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <p>{{ item.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="muted-block" style="margin-top: 8px">
                    <div>
                        Acciones enviadas a: <code id="apiBase">/api/</code>
                    </div>
                    <div class="fs-hint">
                        Consejo: en m√≥vil usa modo horizontal para mejor visual.
                    </div>
                </div>
            </aside>
        </div>
        <audio id="dooropen" preload="auto">
            <source
                src="{{ url_for('static', filename='sounds/open.mp3') }}"
                type="audio/mpeg"
            />
        </audio>

        <audio id="doorbell" preload="auto">
            <source
                src="{{ url_for('static', filename='sounds/doorbell.mp3') }}"
                type="audio/mpeg"
            />
        </audio>

        <script>
            const STREAM_MJPEG = "/live.m3u8";
            const STREAM_HLS = "{{video_url}}"; // si no hay HLS, no es necesario
            const API_BASE = "/api"; // ejemplo: POST /api/open, /api/unlock, /api/snapshot, /api/talk

            var video = document.getElementById("videoStream");
            var videoSrc = "{{ video_url }}"; // Nombre de tu archivo M3U8

            if (Hls.isSupported()) {
                var hls = new Hls({
                    // Ajustes para baja latencia (corta la lista de reproducci√≥n)
                    startPosition: -1,
                    liveSyncDurationCount: 2,
                    liveMaxLatencyDurationCount: 3,
                });
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play();
                });
            } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                // Soporte nativo de HLS (para Safari)
                video.src = videoSrc;
                video.addEventListener("loadedmetadata", function () {
                    setTimeout(() => {
                        video.play();
                        showNotification("Video recargado", "success");
                    }, 100);
                });
            }

            // Try to detect if MJPEG fails ‚Äî then fallback to HLS/video
            let lastFrameTime = performance.now();
            let frames = 0;
            let fpsInterval = null;

            // Capture image--------
            function capturar() {
                const video = document.getElementById("stream");
                const canvas = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const enlace = document.createElement("a");
                enlace.download =
                    "captura_" +
                    new Date().toISOString().replace(/[:.]/g, "_") +
                    ".jpg";
                enlace.href = canvas.toDataURL("image/jpeg");
                enlace.click();
            }

            // ‚öôÔ∏è Token de seguridad (debe coincidir con config.json)
            const API_TOKEN = "1234";

            async function abrirPuerta() {
                const btn = document.getElementById("unlockBtn");
                const status = document.getElementById("nfc-status");
                const beep = document.getElementById("dooropen");

                btn.disabled = true;
                status.textContent = "‚è≥ Enviando se√±al...";
                status.style.color = "#cccccc";

                console.log(`open url: ${API_BASE}/open?token=${API_TOKEN}`);
                try {
                    const response = await fetch(
                        `${API_BASE}/open?token=${API_TOKEN}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ reason: "web_button" }),
                        },
                    );

                    if (response.ok) {
                        const data = await response.json();
                        status.textContent = "‚úÖ Puerta abierta correctamente";
                        status.style.color = "#4caf50";

                        // üîä Reproducir beep de confirmaci√≥n
                        beep.currentTime = 0;
                        beep.play().catch((err) =>
                            console.warn("No se pudo reproducir beep:", err),
                        );
                    } else {
                        status.textContent = "‚ùå Error al abrir puerta";
                        status.style.color = "#f44336";
                    }
                } catch (err) {
                    status.textContent = "‚ö†Ô∏è Error de conexi√≥n con el servidor";
                    status.style.color = "#ff9800";
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        status.textContent = "";
                    }, 4000);
                }
            }

            //Revisar si se queda la funcion !!!
            // Fallback function ‚Äî shows <video> and hides <img>
            function tryFallbackToVideo() {
                // Only attempt if hls URL likely available
                if (!STREAM_HLS) {
                    return;
                }
                mjpeg.style.display = "none";
                hlsVideo.style.display = "block";
                // If the browser supports HLS natively (Safari) it will play. For others you'd need hls.js:
                // We don't include hls.js here; if needed, add it and attach to hlsVideo.
                hlsVideo.src = STREAM_HLS;
                hlsVideo.play().catch(() => {
                    /* ignore autoplay block */
                });
            }
            // Button actions
            async function postAction(action, body = {}) {
                const url = `${API_BASE}/${action}`;
                try {
                    const r = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    if (!r.ok) throw new Error("HTTP " + r.status);
                    const json = await r.json().catch(() => ({ ok: true }));
                    return { ok: true, data: json };
                } catch (err) {
                    console.error("postAction", action, err);
                    return { ok: false, err: err };
                }
            }

            document
                .getElementById("snapshotBtn")
                .addEventListener("click", async () => {
                    // If server supports snapshot endpoint that returns image bytes/base64
                    const resp = await postAction("snapshot");
                    if (resp.ok && resp.data && resp.data.image_base64) {
                        displayThumbnail(resp.data.image_base64);
                    } else if (resp.ok && resp.data && resp.data.url) {
                        displayThumbnailFromUrl(resp.data.url);
                    } else {
                        alert(
                            "Captura solicitada. Si no ves imagen, aseg√∫rate que /api/snapshot devuelve base64 o url.",
                        );
                    }
                });

            document
                .getElementById("talkBtn")
                .addEventListener("click", async () => {
                    // Simple toggle: start/stop talk. Could be long-press for PTT in the future.
                    const resp = await postAction("talk_toggle");
                    if (resp.ok) alert("Toggle talk enviado.");
                    else alert("Error en talk.");
                });

            // Fullscreen
            document
                .getElementById("fullscreenBtn")
                .addEventListener("click", () => {
                    const el = document.getElementById("videoInner");
                    if (!document.fullscreenElement) {
                        el.requestFullscreen?.();
                    } else {
                        document.exitFullscreen?.();
                    }
                });

            // Reload stream
            document
                .getElementById("reloadBtn")
                .addEventListener("click", () => {
                    // reload image by adding cache-buster
                    mjpeg.src = STREAM_MJPEG + "?_t=" + Date.now();
                    setStatus(true);
                    hlsVideo.pause();
                    hlsVideo.style.display = "none";
                    mjpeg.style.display = "block";
                });

            // Thumbnail display helpers
            function displayThumbnail(base64) {
                thumb.innerHTML = "";
                const img = document.createElement("img");
                img.src = "data:image/jpeg;base64," + base64;
                thumb.appendChild(img);
            }

            function displayThumbnailFromUrl(url) {
                thumb.innerHTML = "";
                const img = document.createElement("img");
                img.src = url;
                thumb.appendChild(img);
            }

            // --- üîî Eventos del servidor (SSE) ------------------------
            const evtSource = new EventSource("/events");

            evtSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Evento recibido:", data);

                if (data.type === "nfc_access") {
                    const msg = data.activo
                        ? `‚úÖ Tarjeta ${data.id} autorizada ‚Äî puerta abierta`
                        : `üö´ Tarjeta ${data.id} no autorizada`;
                    showNotification(msg, data.activo ? "success" : "error");
                    if (data.activo) {
                        const audio = new Audio("/static/sounds/open.mp3");
                        audio.play();
                    } else {
                        const audio = new Audio("/static/sounds/failed.mp3");
                        audio.play();
                    }
                }
            };

            // Simple helper para mostrar notificaciones
            function showNotification(msg, type = "info") {
                const el = document.createElement("div");
                el.textContent = msg;
                el.className = `notif ${type}`;
                Object.assign(el.style, {
                    position: "fixed",
                    bottom: "10px",
                    right: "10px",
                    background:
                        type === "error"
                            ? "#f44336"
                            : type === "success"
                              ? "#4caf50"
                              : "#333",
                    color: "#fff",
                    padding: "10px 15px",
                    borderRadius: "8px",
                    zIndex: 9999,
                    fontSize: "0.9rem",
                    transition: "opacity 0.5s",
                    opacity: 0.95,
                });
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        </script>

        <!==============  Script para el uso del socket.io   =================>
        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
        <script>
            const socket = io();

            // üü¢ Escuchar evento de timbre f√≠sico
            socket.on("alert_request", (data) => {
                // üîä Reproducir sonido
                const audio = document.getElementById("doorbell");
                audio.currentTime = 0;
                audio
                    .play()
                    .catch((err) =>
                        console.warn("No se pudo reproducir sonido:", err),
                    );

                const alertDiv = document.createElement("div");
                alertDiv.textContent = data.message || "üö® Alerta";
                alertDiv.style.position = "fixed";
                alertDiv.style.top = "20px";
                alertDiv.style.right = "20px";
                alertDiv.style.background = "#ff9800";
                alertDiv.style.color = "#000";
                alertDiv.style.padding = "12px 18px";
                alertDiv.style.borderRadius = "8px";
                alertDiv.style.fontWeight = "bold";
                alertDiv.style.zIndex = "9999";
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 6000);
            });

            //============== Inicializar audio una vez el usuario interact√∫e (para evitar bloqueo de autoplay)
            let audioReady = false;
            document.body.addEventListener("click", () => {
                if (!audioReady) {
                    const audio = document.getElementById("doorbell");
                    audio
                        .play()
                        .then(() => {
                            audio.pause();
                            audio.currentTime = 0;
                            console.log(
                                "üîà Audio listo para reproducir en eventos futuros",
                            );
                        })
                        .catch((err) => {
                            console.warn(
                                "‚ö†Ô∏è El navegador bloque√≥ el audio:",
                                err,
                            );
                        });
                    audioReady = true;
                }
            });

            //==================== Cuando llegue el evento de timbre desde el servidor
            function playDoorbell() {
                const audio = document.getElementById("doorbell");
                audio.currentTime = 0;
                audio
                    .play()
                    .catch((err) =>
                        console.warn("Error al reproducir doorbell:", err),
                    );
            }

            // ==================== NFC lecturas  ===============================
            socket.on("nfc_access", (data) => {
                console.log("Tarjeta detectada:", data);
                const status = data.activo
                    ? "‚úÖ Acceso permitido"
                    : "üö´ Acceso denegado";
                const color = data.activo ? "green" : "red";
                const cardInfo = `
                <div style="padding:10px;margin-top:10px;border:2px solid ${color};border-radius:8px">
                  <b>${status}  </b>
                   ID: ${data.id}   <br>
                  Nombre: ${data.nombre || "Desconocido"}
                </div>`;
                document.getElementById("nfc-status").innerHTML = cardInfo;
                if (!data.activo) {
                    addElement(data);
                }
            });

            //  ================   Accordion para las lecturas  ======================
            let isAccordionOpen = false;
            let elementCount = 0;

            // Funci√≥n para alternar el accordion principal
            function toggleMainAccordion() {
                const content = document.getElementById("mainAccordionContent");
                const icon = document.getElementById("mainAccordionIcon");

                isAccordionOpen = !isAccordionOpen;
                content.classList.toggle("open");
                icon.classList.toggle("open");
            }

            // Funci√≥n para agregar nuevo elemento a la tabla
            function addElement(item) {
                // Incrementar contador
                elementCount++;

                // Asegurar que el accordion est√© abierto
                if (!isAccordionOpen) {
                    toggleMainAccordion();
                }

                // Ocultar estado vac√≠o si existe
                const emptyState = document.getElementById("emptyState");
                if (emptyState && emptyState.parentElement.parentElement) {
                    emptyState.parentElement.parentElement.remove();
                }

                // Crear nueva fila en la tabla
                const tableBody = document.getElementById("elementsTableBody");
                const newRow = document.createElement("tr");
                newRow.className = "fade-in";

                const now = new Date();
                const dateString =
                    now.toLocaleDateString("es-ES", {
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                    }) +
                    " " +
                    now.toLocaleTimeString("es-ES", {
                        hour: "2-digit",
                        minute: "2-digit",
                    });

                newRow.innerHTML = `
                <td class="uid-cell">${item.id}</td>
                <td class="name-cell">${item.nombre}</td>
                <td class="date-cell">${dateString}</td>
            `;

                // Agregar a la tabla
                tableBody.appendChild(newRow);

                // Actualizar contador
                updateElementCounter();
            }

            // Funci√≥n para actualizar contador
            function updateElementCounter() {
                const countElement = document.getElementById("elementCount");
                const rows = document.querySelectorAll("#elementsTableBody tr");
                const validRows = Array.from(rows).filter(
                    (row) => !row.querySelector(".empty-state"),
                );
                countElement.textContent = validRows.length;
            }
        </script>
    </body>
</html>
