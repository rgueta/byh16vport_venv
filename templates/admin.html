<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel NFC</title>
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/pages/admin.css') }}"
/>
</head>
<body>
<h1>üîê Administraci√≥n de Tarjetas NFC</h1>
<h2>üß† Modo Aprendizaje NFC</h2>
<form action="/admin/learn/{{ 'off' if nfcModule.learn_mode else 'on' }}" method="POST">
  {% if nfcModule.learn_mode %}
  <button style="background:#a00;">Desactivar aprendizaje</button>
  {% else %}
  <button style="background:#0a0;">Activar aprendizaje</button>
  {% endif %}
</form>

<h2>Agregar tarjeta manualmente</h2>
<!--<form action="/admin/add" method="POST">-->
<form>
  ID: <input id="id" name="id" required readonly>
  Nombre: <input id="nombre" name="nombre" required>
  TipoUsuario:
  <select id="tipoUsuario" name="tipoUsuario">
    <option value="usuario">Usuario</option>
    <option value="admin">Administrador</option>
  </select>
  <button onclick="agregarTag(event)">‚ûï Agregar</button>
</form>

<h2>Tarjetas registradas</h2>
<table>
  <tr><th>ID</th><th>Nombre</th><th>APaterno</th><th>AMaterno</th>
      <th>Email</th><th>TipoUsuario</th><th>Activo</th><th>Acciones</th>
  </tr>
  {% for id, nombre, ap, am, email, tipo, activo in usuarios %}
  <tr>
    <td>{{ id }}</td>
    <td>
      <form action="/admin/update/{{ id }}" method="POST">
        <input name="nombre" value="{{ nombre }}">
    </td>
    <td><input name="APaterno" value="{{ ap }}"></td>
    <td><input name="AMaterno" value="{{ am }}"></td>
    <td><input name="Email" value="{{ email }}"></td>
    <td>
        <select name="tipoId">
            {% for id, tipo in tipoUsuario %}
            <option
                value="{{ id }}"
                {% if id == tipoId %}selected{% endif %}>
                {{ tipo }}
            </option>
            {% endfor %}
        </select>
    </td>
    <td>
        <input name="activo" type="checkbox" value="1"
            {% if activo==1 %}checked{% endif %}
        >
    </td>
    <td>
        <button title="Guardar">üíæ</button>
      </form>
      <form action="/admin/delete/{{ id }}" method="POST" onsubmit="return confirm('¬øEliminar tarjeta?')">
        <button title="Borrar" style="background:#a00;">üóëÔ∏è</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>

<p><a href="/">‚¨ÖÔ∏è Volver al videoportero</a></p>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const Id = document.getElementById("id");
    const Nombre = document.getElementById("nombre");
    const tipoUsuario = document.getElementById("tipoUsuario");

    const socket = io();
     socket.on("nfc_access", data => {
       Id.value = data.id;
       console.log("Tarjeta detectada:", data);
       const status = data.activo ? "‚úÖ Acceso permitido" : "üö´ Acceso denegado";
       const color = data.activo ? "green" : "red";
       const cardInfo = `
         <div style="padding:10px;margin-top:10px;border:2px solid ${color};border-radius:8px">
           <b>${status}</b><br>
           UID: ${data.id}<br>
           Nombre: ${data.nombre || 'Desconocido'}
         </div>`;
       document.getElementById("nfc-status").innerHTML = cardInfo;
     });

 function LeerTarjetas(){
   try {
       const response = await fetch('/admin/add', {
           method: 'POST', // Usamos el m√©todo POST para enviar datos
           headers: {
               'Content-Type': 'application/json' // Indicamos que el cuerpo es JSON
           },
           body: JSON.stringify(tagData) // Convertimos el objeto a cadena JSON
       });

       // 4. Procesar la respuesta del servidor
       if (response.ok) {
           const result = await response.json();
           alert(`‚úÖ Tarjeta agregada con √©xito! Mensaje: ${result.message || 'OK'}`);

           // Opcional: Recargar la p√°gina para ver la tarjeta en la tabla
           window.location.reload();
       } else {
           const errorResult = await response.json();
           alert(`‚ùå Error al agregar tarjeta: ${errorResult.error || response.statusText}`);
       }

   } catch (error) {
       console.error('Error de red o del servidor:', error);
       alert('‚ùå Fallo la comunicaci√≥n con el servidor.');
   }
 }

  async function agregarTag(event){
    if (event) {
            event.preventDefault();
        }
       console.log('se agregara: ' +
          JSON.stringify({'uid':Id.value, 'name': Nombre.value, 'tipoId': tipoUsuario.value }));


     // 2. Validaci√≥n de Inputs
        if (Id.value == "" || Nombre.value == "") {
            alert("‚ö†Ô∏è El campo UID y Nombre son obligatorios.");
            Id.focus();
            return; // Detiene la funci√≥n si el UID est√° vac√≠o
        }

        // El campo 'Nombre' y 'Nivel' siempre tendr√°n un valor (el nombre puede estar vac√≠o, pero no es requerido por HTML)

        const tagData = {'id': Id.value,'nombre': Nombre.value,'level': tipoUsuario.value};
        console.log('Datos a enviar: ', JSON.stringify(tagData));

        // 3. Env√≠o del objeto JSON a /admin/add
        try {
            const response = await fetch('/admin/add', {
                method: 'POST', // Usamos el m√©todo POST para enviar datos
                headers: {
                    'Content-Type': 'application/json' // Indicamos que el cuerpo es JSON
                },
                body: JSON.stringify(tagData) // Convertimos el objeto a cadena JSON
            });

            // 4. Procesar la respuesta del servidor
            if (response.ok) {
                const result = await response.json();
                alert(`‚úÖ Tarjeta agregada con √©xito! Mensaje: ${result.message || 'OK'}`);

                // Opcional: Recargar la p√°gina para ver la tarjeta en la tabla
                window.location.reload();
            } else {
                const errorResult = await response.json();
                alert(`‚ùå Error al agregar tarjeta: ${errorResult.error || response.statusText}`);
            }

        } catch (error) {
            console.error('Error de red o del servidor:', error);
            alert('‚ùå Fallo la comunicaci√≥n con el servidor.');
        }
    }


</script>
<div id="nfc-status"></div>
</body>
</html>
