<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Panel NFC</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/pages/admin.css') }}"
        />
    </head>
    <body>
        <h1>üîê Administraci√≥n de Tarjetas NFC</h1>
        <details class="card form-container">
            <summary>
                <h2>‚ûï Agregar/Editar Usuario</h2>
            </summary>

            <form id="userForm">
                <div class="form-group-row">
                    <div class="form-group">
                        <label for="inputId">Id:</label>
                        <input type="text" id="inputId" name="Id" required />
                    </div>
                    <div class="form-group">
                        <label for="inputNombre">Nombre:</label>
                        <input type="text" id="inputNombre" name="nombre" required />
                    </div>
                    <div class="form-group">
                        <label for="inputAPaterno">Apellido Paterno:</label>
                        <input type="text" id="inputAPaterno" name="aPaterno" required />
                    </div>
                    <div class="form-group">
                        <label for="inputAMaterno">Apellido Materno:</label>
                        <input type="text" id="inputAMaterno" name="aMaterno" />
                    </div>
                </div>

                <div class="form-group-row">
                    <div class="form-group">
                        <label for="inputEmail">Email:</label>
                        <input type="email" id="inputEmail" name="email" required />
                    </div>
                    <div class="form-group">
                        <label for="inputPwd">Contrase√±a (PWD):</label>
                        <input type="password" id="inputPwd" name="pwd" placeholder="Dejar vac√≠o para no cambiar" />
                    </div>
                    <div class="form-group">
                        <label for="inputCell">Tel√©fono (Cell):</label>
                        <input type="text" id="inputCell" name="cell" />
                    </div>
                </div>

                <div class="form-group-row">
                    <div class="form-group">
                        <label for="selectTipo">Tipo ID:</label>
                        <select id="selectTipo" name="tipo">
                            <option value="">Selecciona un tipo de usuario</option>
                            {% for id,tipo in tipoUsuario %}
                                <option value="{{id}}">{{tipo}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-group-row control-row">
                    <div>
                        <label for="checkOperador">Operador:</label>
                        <input type="checkbox" id="checkOperador" name="operador" value = '1' />
                    </div>

                    <div>
                        <label for="checkActivo">Activo:</label>
                        <input type="checkbox" id="checkActivo" name="activo" value = '1' checked />
                    </div>
                    <div>
                        <button type="submit" id="saveButton" class="btn primary">
                            üíæ Guardar Usuario
                        </button>
                        <button type="button" id="cancelButton" class="btn secondary" style="display: none">
                            Cancelar Edici√≥n
                        </button>
                    </div>
                </div>
            </form>
            <p><a href="/">‚¨ÖÔ∏è Volver al videoportero</a></p>
        </details>
        <h2>Tarjetas registradas</h2>
        <table id="userTable">
            <tr><th>ID</th><th>Nombre</th><th>Email</th><th>TipoUsuario</th>
                <th>Activo</th><th>Operador</th><th>Acciones</th>
            </tr>
            {% for id, nombre, ap, am, email, tipo, activo, operador in usuarios %}
            <tr>
            <td>{{ id }}</td>
            <td>
                <form action="/admin/update/{{ id }}" method="POST">
                    <input name="nombre" value="{{ nombre }} {{ ap }} {{ am }}">
                    </td>
                    <!--<td><input name="APaterno" value="{{ ap }}"></td>
                    <td><input name="AMaterno" value="{{ am }}"></td>-->
                    <td><input name="Email" value="{{ email }}"></td>
                    <td>
                        <select name="tipoId">
                            {% for id, tipo in tipoUsuario %}
                            <option
                                value="{{ id }}"
                                {% if id == tipoId %}selected{% endif %}>
                                {{ tipo }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input name="activo" type="checkbox" value="1"
                            {% if activo==1 %}checked{% endif %}
                        >
                    </td>
                    <td>
                        <input name="operador" type="checkbox" value="1"
                            {% if operador==1 %}checked{% endif %}
                        >
                    </td>
                    <td>
                        <button title="Editar">‚úèÔ∏è</button>
                </form>
            <form action="/admin/delete/{{ id }}" method="POST" onsubmit="return confirm('¬øEliminar tarjeta?')">
                <button title="Borrar" style="background:#a00;">üóëÔ∏è</button>
            </form>
            </td>
            </tr>
            {% endfor %}
        </table>
        <!-- JavaScript para manejar el env√≠o del formulario -->
        <script>

        <!------------    Guardar nuevo Usuario   ------>
        document.getElementById('userForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevenir env√≠o tradicional del formulario

            // Recopilar datos del formulario
            const formData = new FormData(this);

            // Convertir FormData a objeto JSON
            const jsonData = {
                    id: document.getElementById('inputId').value,
                    nombre: document.getElementById('inputNombre').value,
                    ap: document.getElementById('inputAPaterno').value,
                    ap: document.getElementById('inputAMaterno').value,
                    email: document.getElementById('inputEmail').value,
                    pwd: document.getElementById('inputPwd').value,
                    cell: document.getElementById('inputCell').value,
                    tipoId: document.getElementById('selectTipo').value,
                    // Checkboxes manejados directamente
                    operador: document.getElementById('checkOperador').checked ? '1' : '0',
                    activo: document.getElementById('checkActivo').checked ? '1' : '0'
                };

            // Mostrar loading en el bot√≥n
            const saveButton = document.getElementById('saveButton');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '‚è≥ Guardando...';
            saveButton.disabled = true;
            console.log('jsonData: ', jsonData);

            // Enviar datos al servidor Flask
            fetch('/guardar-usuario', {  // Cambia esta URL por tu endpoint de Flask
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                // Manejar respuesta exitosa
                console.log('Usuario guardado:', data);
                alert('‚úÖ Usuario guardado exitosamente');

                // Resetear formulario si es necesario
                this.reset();

                // Aqu√≠ puedes agregar m√°s l√≥gica seg√∫n la respuesta
                if (data.redirect) {
                    window.location.href = data.redirect;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error al guardar el usuario: ' + error.message);
            })
            .finally(() => {
                // Restaurar bot√≥n
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            });
        });

        // Manejar el bot√≥n cancelar si es necesario
        document.getElementById('cancelButton').addEventListener('click', function() {
            document.getElementById('userForm').reset();
            this.style.display = 'none';
            // Aqu√≠ puedes agregar m√°s l√≥gica para cancelar edici√≥n
        });
        </script>

        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
        <script>
            const Id = document.getElementById("inputId");
            const Nombre = document.getElementById("nombre");
            const tipoUsuario = document.getElementById("tipoUsuario");

            const socket = io();
            socket.on("nfc_access", data => {
            Id.value = data.id;
            console.log("Tarjeta detectada:", data);
            const status = data.activo ? "‚úÖ Acceso permitido" : "üö´ Acceso denegado";
            const color = data.activo ? "green" : "red";
            const cardInfo = `
                <div style="padding:10px;margin-top:10px;border:2px solid ${color};border-radius:8px">
                <b>${status}</b><br>
                UID: ${data.id}<br>
                Nombre: ${data.nombre || 'Desconocido'}
                </div>`;
            document.getElementById("nfc-status").innerHTML = cardInfo;
            });

            userTable.addEventListener("click", (e) => {
                if (e.target.classList.contains("edit-btn")) {
                    // ... (Tu c√≥digo para cargar los datos en el formulario) ...

                    // üí° Abrir la secci√≥n colapsable al hacer clic en Editar
                    document.querySelector(".form-container").open = true;

                    saveButton.textContent = "üíæ Actualizar Usuario";
                    // ...
                }
            });

            async function LeerTarjetas(){
              try {
                  const response = await fetch('/admin/add', {
                      method: 'POST', // Usamos el m√©todo POST para enviar datos
                      headers: {
                          'Content-Type': 'application/json' // Indicamos que el cuerpo es JSON
                      },
                      body: JSON.stringify(tagData) // Convertimos el objeto a cadena JSON
                  });

                  // 4. Procesar la respuesta del servidor
                  if (response.ok) {
                      const result = await response.json();
                      alert(`‚úÖ Tarjeta agregada con √©xito! Mensaje: ${result.message || 'OK'}`);

                      // Opcional: Recargar la p√°gina para ver la tarjeta en la tabla
                      window.location.reload();
                  } else {
                      const errorResult = await response.json();
                      alert(`‚ùå Error al agregar tarjeta: ${errorResult.error || response.statusText}`);
                  }

              } catch (error) {
                  console.error('Error de red o del servidor:', error);
                  alert('‚ùå Fallo la comunicaci√≥n con el servidor.');
              }
            }

            async function agregarTag(event){
              if (event) {
                      event.preventDefault();
                  }
                console.log('se agregara: ' +
                    JSON.stringify({'uid':Id.value, 'name': Nombre.value, 'tipoId': tipoUsuario.value }));


               // 2. Validaci√≥n de Inputs
                if (Id.value == "" || Nombre.value == "") {
                    alert("‚ö†Ô∏è El campo UID y Nombre son obligatorios.");
                    Id.focus();
                    return; // Detiene la funci√≥n si el UID est√° vac√≠o
                }

                // El campo 'Nombre' y 'Nivel' siempre tendr√°n un valor (el nombre puede estar vac√≠o, pero no es requerido por HTML)

                const tagData = {'id': Id.value,'nombre': Nombre.value,'level': tipoUsuario.value};
                console.log('Datos a enviar: ', JSON.stringify(tagData));

                // 3. Env√≠o del objeto JSON a /admin/add
                try {
                    const response = await fetch('/admin/add', {
                        method: 'POST', // Usamos el m√©todo POST para enviar datos
                        headers: {
                            'Content-Type': 'application/json' // Indicamos que el cuerpo es JSON
                        },
                        body: JSON.stringify(tagData) // Convertimos el objeto a cadena JSON
                    });

                    // 4. Procesar la respuesta del servidor
                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ Tarjeta agregada con √©xito! Mensaje: ${result.message || 'OK'}`);

                        // Opcional: Recargar la p√°gina para ver la tarjeta en la tabla
                        window.location.reload();
                    } else {
                        const errorResult = await response.json();
                        alert(`‚ùå Error al agregar tarjeta: ${errorResult.error || response.statusText}`);
                    }

                } catch (error) {
                    console.error('Error de red o del servidor:', error);
                    alert('‚ùå Fallo la comunicaci√≥n con el servidor.');
                }
            }


        </script>
        <div id="nfc-status"></div>
    </body>
</html>
