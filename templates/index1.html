<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Videoportero - Panel</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/pages/index.css') }}"
        />
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üö™ Video Portero Inteligente.</h1>
                <p>Stream MJPEG Funcional - Modo Diagn√≥stico</p>
            </div>

            <div class="status-bar">
                <div class="status-item" id="streamStatus">
                    <h3>Stream</h3>
                    <p>üîÑ CONECTANDO...</p>
                </div>
                <div class="status-item" id="doorStatus">
                    <h3>Puerta</h3>
                    <p>üîí CERRADA</p>
                </div>
                <div class="status-item" id="frameStatus">
                    <h3>Frames</h3>
                    <p>0</p>
                </div>
            </div>

            <!-- Video + header -->
            <div class="card video-card">
                <div class="topbar">
                    <div class="title">Videoportero</div>
                    <div class="status">
                        <span class="dot" id="connDot"></span
                        ><span id="connText">Conectando...</span>
                    </div>
                </div>

                <div class="video-inner" id="videoInner">
                    <img id="stream" src="{{ url_for('video_feed') }}" />
                    <canvas
                        id="canvas"
                        width="640"
                        height="480"
                        style="display: none"
                    ></canvas>
                </div>

                <div
                    style="
                        padding: 10px 4px;
                        display: flex;
                        gap: 10px;
                        align-items: center;
                        justify-content: space-between;
                    "
                >
                    <div id="status" class="small"></div>
                    <div class="small">
                        Touch-friendly UI ‚Äî compatible PC & m√≥viles
                    </div>
                    <div class="small">
                        FPS estimado: <span id="fps">‚Äî</span>
                    </div>
                </div>
            </div>

            <!-- Control panel -->
            <aside class="controls card">
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        align-items: center;
                        justify-content: space-between;
                    "
                >
                    <strong>Controles</strong>
                    <button
                        id="reloadBtn"
                        class="btn"
                        style="padding: 8px 10px; font-size: 0.9rem"
                    >
                        üîÅ Refrescar
                    </button>
                </div>

                <div class="btn-grid" style="margin-top: 6px">
                    <button
                        class="btn primary"
                        id="openBtn"
                        title="Abrir port√≥n/puerta"
                        onclick="abrirPuerta()"
                    >
                        üîì Abrir
                    </button>
                    <button
                        class="btn warn"
                        id="unlockBtn"
                        title="Desbloquear remoto"
                    >
                        üîë Desbloquear
                    </button>
                    <button
                        class="btn"
                        id="snapshotBtn"
                        title="Tomar foto"
                        onclick="capturar()"
                    >
                        üì∏ Captura.
                    </button>
                    <button
                        class="btn"
                        id="talkBtn"
                        title="Hablar (push to talk)"
                    >
                        üéôÔ∏è Hablar
                    </button>
                    <button
                        class="btn"
                        id="fullscreenBtn"
                        title="Pantalla completa"
                    >
                        ‚§¢ Pantalla
                    </button>
                </div>

                <div style="margin-top: 12px">
                    <div class="small">Captura reciente</div>
                    <div class="thumb" id="thumb">
                        <span id="thumbText">Sin captura</span>
                    </div>
                </div>

                <div class="muted-block" style="margin-top: 8px">
                    <div>
                        Acciones enviadas a: <code id="apiBase">/api/</code>
                    </div>
                    <div class="fs-hint">
                        Consejo: en m√≥vil usa modo horizontal para mejor visual.
                    </div>
                </div>
            </aside>
        </div>
        <audio id="dooropen" preload="auto">
            <source
                src="{{ url_for('static', filename='sounds/open.mp3') }}"
                type="audio/mpeg"
            />
        </audio>

        <audio id="doorbell" preload="auto">
            <source
                src="{{ url_for('static', filename='sounds/doorbell.mp3') }}"
                type="audio/mpeg"
            />
        </audio>

        <script>
            const STREAM_MJPEG = "/live.m3u8";
            const STREAM_HLS = "{{video_url}}"; // si no hay HLS, no es necesario
            const API_BASE = "/api"; // ejemplo: POST /api/open, /api/unlock, /api/snapshot, /api/talk

            var video = document.getElementById("videoStream");
            var videoSrc = "{{ video_url }}"; // Nombre de tu archivo M3U8

            if (Hls.isSupported()) {
                var hls = new Hls({
                    // Ajustes para baja latencia (corta la lista de reproducci√≥n)
                    startPosition: -1,
                    liveSyncDurationCount: 2,
                    liveMaxLatencyDurationCount: 3,
                });
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play();
                });
            } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                // Soporte nativo de HLS (para Safari)
                video.src = videoSrc;
                video.addEventListener("loadedmetadata", function () {
                    setTimeout(() => {
                        video.play();
                        showNotification("Video recargado", "success");
                    }, 100);
                });
            }

            // Update UI
            document.getElementById("apiBase").textContent = API_BASE;

            // Elements
            const mjpeg = document.getElementById("mjpeg");
            const hlsVideo = document.getElementById("videoStream");
            const connDot = document.getElementById("connDot");
            const connText = document.getElementById("connText");
            const fpsLabel = document.getElementById("fps");
            const thumb = document.getElementById("thumb");
            const thumbText = document.getElementById("thumbText");

            // Try to detect if MJPEG fails ‚Äî then fallback to HLS/video
            let lastFrameTime = performance.now();
            let frames = 0;
            let fpsInterval = null;
            //Revisar si se queda la funcion !!!
            function setStatus(connected) {
                if (connected) {
                    connDot.style.background = "#10b981";
                    connText.textContent = "Conectado";
                } else {
                    connDot.style.background = "#ef4444";
                    connText.textContent = "Desconectado";
                }
            }

            // Start FPS meter
            fpsInterval = setInterval(() => {
                fpsLabel.textContent = frames;
                frames = 0;
            }, 1000);

            // Capture image--------
            function capturar() {
                const video = document.getElementById("stream");
                const canvas = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const enlace = document.createElement("a");
                enlace.download =
                    "captura_" +
                    new Date().toISOString().replace(/[:.]/g, "_") +
                    ".jpg";
                enlace.href = canvas.toDataURL("image/jpeg");
                enlace.click();
            }

            // ‚öôÔ∏è Token de seguridad (debe coincidir con config.json)
            const API_TOKEN = "1234";

            async function abrirPuerta() {
                const btn = document.getElementById("unlockBtn");
                const status = document.getElementById("status");
                const beep = document.getElementById("dooropen");

                btn.disabled = true;
                status.textContent = "‚è≥ Enviando se√±al...";
                status.style.color = "#cccccc";

                console.log(`open url: ${API_BASE}/open?token=${API_TOKEN}`);
                try {
                    const response = await fetch(
                        `${API_BASE}/open?token=${API_TOKEN}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ reason: "web_button" }),
                        },
                    );

                    if (response.ok) {
                        const data = await response.json();
                        status.textContent = "‚úÖ Puerta abierta correctamente";
                        status.style.color = "#4caf50";

                        // üîä Reproducir beep de confirmaci√≥n
                        beep.currentTime = 0;
                        beep.play().catch((err) =>
                            console.warn("No se pudo reproducir beep:", err),
                        );
                    } else {
                        status.textContent = "‚ùå Error al abrir puerta";
                        status.style.color = "#f44336";
                    }
                } catch (err) {
                    status.textContent = "‚ö†Ô∏è Error de conexi√≥n con el servidor";
                    status.style.color = "#ff9800";
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        status.textContent = "";
                    }, 4000);
                }
            }

            //Revisar si se queda la funcion !!!
            // Fallback function ‚Äî shows <video> and hides <img>
            function tryFallbackToVideo() {
                // Only attempt if hls URL likely available
                if (!STREAM_HLS) {
                    connText.textContent = "Stream no disponible";
                    return;
                }
                mjpeg.style.display = "none";
                hlsVideo.style.display = "block";
                // If the browser supports HLS natively (Safari) it will play. For others you'd need hls.js:
                // We don't include hls.js here; if needed, add it and attach to hlsVideo.
                hlsVideo.src = STREAM_HLS;
                hlsVideo.play().catch(() => {
                    /* ignore autoplay block */
                });
            }

            // Button actions
            async function postAction(action, body = {}) {
                const url = `${API_BASE}/${action}`;
                try {
                    const r = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    if (!r.ok) throw new Error("HTTP " + r.status);
                    const json = await r.json().catch(() => ({ ok: true }));
                    return { ok: true, data: json };
                } catch (err) {
                    console.error("postAction", action, err);
                    return { ok: false, err: err };
                }
            }

            document
                .getElementById("snapshotBtn")
                .addEventListener("click", async () => {
                    // If server supports snapshot endpoint that returns image bytes/base64
                    const resp = await postAction("snapshot");
                    if (resp.ok && resp.data && resp.data.image_base64) {
                        displayThumbnail(resp.data.image_base64);
                    } else if (resp.ok && resp.data && resp.data.url) {
                        displayThumbnailFromUrl(resp.data.url);
                    } else {
                        alert(
                            "Captura solicitada. Si no ves imagen, aseg√∫rate que /api/snapshot devuelve base64 o url.",
                        );
                    }
                });

            document
                .getElementById("talkBtn")
                .addEventListener("click", async () => {
                    // Simple toggle: start/stop talk. Could be long-press for PTT in the future.
                    const resp = await postAction("talk_toggle");
                    if (resp.ok) alert("Toggle talk enviado.");
                    else alert("Error en talk.");
                });

            // Fullscreen
            document
                .getElementById("fullscreenBtn")
                .addEventListener("click", () => {
                    const el = document.getElementById("videoInner");
                    if (!document.fullscreenElement) {
                        el.requestFullscreen?.();
                    } else {
                        document.exitFullscreen?.();
                    }
                });

            // Reload stream
            document
                .getElementById("reloadBtn")
                .addEventListener("click", () => {
                    // reload image by adding cache-buster
                    mjpeg.src = STREAM_MJPEG + "?_t=" + Date.now();
                    setStatus(true);
                    hlsVideo.pause();
                    hlsVideo.style.display = "none";
                    mjpeg.style.display = "block";
                });

            // Thumbnail display helpers
            function displayThumbnail(base64) {
                thumb.innerHTML = "";
                const img = document.createElement("img");
                img.src = "data:image/jpeg;base64," + base64;
                thumb.appendChild(img);
                thumbText.style.display = "none";
            }

            function displayThumbnailFromUrl(url) {
                thumb.innerHTML = "";
                const img = document.createElement("img");
                img.src = url;
                thumb.appendChild(img);
                thumbText.style.display = "none";
            }

            // --- üîî Eventos del servidor (SSE) ------------------------
            const evtSource = new EventSource("/events");

            evtSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Evento recibido:", data);

                if (data.type === "nfc_access") {
                    const msg = data.allowed
                        ? `‚úÖ Tarjeta ${data.uid} autorizada ‚Äî puerta abierta`
                        : `üö´ Tarjeta ${data.uid} no autorizada`;
                    showNotification(msg, data.allowed ? "success" : "error");
                    if (data.allowed) {
                        const audio = new Audio("/static/sounds/open.mp3");
                        audio.play();
                    } else {
                        const audio = new Audio("/static/sounds/canary.mp3");
                        audio.play();
                    }
                }
            };

            // Simple helper para mostrar notificaciones
            function showNotification(msg, type = "info") {
                const el = document.createElement("div");
                el.textContent = msg;
                el.className = `notif ${type}`;
                Object.assign(el.style, {
                    position: "fixed",
                    bottom: "10px",
                    right: "10px",
                    background:
                        type === "error"
                            ? "#f44336"
                            : type === "success"
                              ? "#4caf50"
                              : "#333",
                    color: "#fff",
                    padding: "10px 15px",
                    borderRadius: "8px",
                    zIndex: 9999,
                    fontSize: "0.9rem",
                    transition: "opacity 0.5s",
                    opacity: 0.95,
                });
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        </script>

        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
        <script>
            const socket = io();

            // üü¢ Escuchar evento de timbre f√≠sico
            socket.on("alert_request", (data) => {
                // üîä Reproducir sonido
                const audio = document.getElementById("doorbell");
                audio.currentTime = 0;
                audio
                    .play()
                    .catch((err) =>
                        console.warn("No se pudo reproducir sonido:", err),
                    );

                const alertDiv = document.createElement("div");
                alertDiv.textContent = data.message || "üö® Alerta";
                alertDiv.style.position = "fixed";
                alertDiv.style.top = "20px";
                alertDiv.style.right = "20px";
                alertDiv.style.background = "#ff9800";
                alertDiv.style.color = "#000";
                alertDiv.style.padding = "12px 18px";
                alertDiv.style.borderRadius = "8px";
                alertDiv.style.fontWeight = "bold";
                alertDiv.style.zIndex = "9999";
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 6000);
            });

            // üîí Escuchar estado de puerta
            socket.on("door_status", (data) => {
                const doorStatus = document
                    .getElementById("doorStatus")
                    .querySelector("p");
                if (data.status === "open") {
                    doorStatus.textContent = "üîì ABIERTA";
                    doorStatus.style.color = "#4caf50";
                } else {
                    doorStatus.textContent = "üîí CERRADA";
                    doorStatus.style.color = "#00bcd4";
                }
            });

            // Inicializar audio una vez el usuario interact√∫e (para evitar bloqueo de autoplay)
            let audioReady = false;
            document.body.addEventListener("click", () => {
                if (!audioReady) {
                    const audio = document.getElementById("doorbell");
                    audio
                        .play()
                        .then(() => {
                            audio.pause();
                            audio.currentTime = 0;
                            console.log(
                                "üîà Audio listo para reproducir en eventos futuros",
                            );
                        })
                        .catch((err) => {
                            console.warn(
                                "‚ö†Ô∏è El navegador bloque√≥ el audio:",
                                err,
                            );
                        });
                    audioReady = true;
                }
            });

            // Cuando llegue el evento de timbre desde el servidor
            function playDoorbell() {
                const audio = document.getElementById("doorbell");
                audio.currentTime = 0;
                audio
                    .play()
                    .catch((err) =>
                        console.warn("Error al reproducir doorbell:", err),
                    );
            }
        </script>
    </body>
</html>
